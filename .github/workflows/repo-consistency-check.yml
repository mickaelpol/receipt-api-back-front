name: Repository Consistency Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # V√©rification quotidienne √† 2h du matin
    - cron: '0 2 * * *'

jobs:
  consistency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup permissions
      run: |
        chmod +x scripts/*.sh
        
    - name: Check repository consistency
      run: |
        echo "üîç V√©rification de la consistance du repository..."
        ./scripts/check-repo-consistency.sh
        
    - name: Check for orphan files
      run: |
        echo "üîç D√©tection des fichiers orphelins..."
        ./scripts/check-orphan-files.sh
        
    - name: Check for multiple READMEs
      run: |
        echo "üîç V√©rification des README multiples..."
        README_COUNT=$(find . -name "README.md" -not -path "./.git/*" | wc -l)
        if [ "$README_COUNT" -gt 1 ]; then
          echo "‚ùå Plusieurs README.md trouv√©s:"
          find . -name "README.md" -not -path "./.git/*"
          exit 1
        else
          echo "‚úÖ Un seul README.md trouv√©"
        fi
        
    - name: Check for orphan documentation
      run: |
        echo "üîç V√©rification des docs orphelines..."
        ORPHAN_DOCS=$(find . -name "*.md" -not -name "README.md" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./vendor/*" 2>/dev/null || true)
        if [ -n "$ORPHAN_DOCS" ]; then
          echo "‚ùå Docs orphelines d√©tect√©es:"
          echo "$ORPHAN_DOCS"
          exit 1
        else
          echo "‚úÖ Aucune doc orpheline trouv√©e"
        fi
        
    - name: Check project structure
      run: |
        echo "üîç V√©rification de la structure du projet..."
        EXPECTED_DIRS=("frontend" "backend" "infra" "scripts")
        for dir in "${EXPECTED_DIRS[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "‚ùå Dossier $dir manquant"
            exit 1
          else
            echo "‚úÖ Dossier $dir pr√©sent"
          fi
        done
        
    - name: Check for temporary files
      run: |
        echo "üîç V√©rification des fichiers temporaires..."
        TEMP_FILES=$(find . -name "*.tmp" -o -name "*.log" -o -name "*.cache" -o -name ".DS_Store" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "./vendor/*" 2>/dev/null || true)
        if [ -n "$TEMP_FILES" ]; then
          echo "‚ö†Ô∏è Fichiers temporaires d√©tect√©s:"
          echo "$TEMP_FILES"
          echo "üí° Consid√©rez les supprimer pour maintenir la propret√© du repo"
        else
          echo "‚úÖ Aucun fichier temporaire trouv√©"
        fi
        
    - name: Summary
      run: |
        echo ""
        echo "üéâ V√©rifications de consistance termin√©es !"
        echo "   - Structure du projet ‚úÖ"
        echo "   - README unique ‚úÖ"
        echo "   - Aucune doc orpheline ‚úÖ"
        echo "   - Fichiers orphelins v√©rifi√©s ‚úÖ"
