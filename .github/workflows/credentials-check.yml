name: Credentials Security Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  credentials-security:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: json, curl
        
    - name: Make scripts executable
      run: |
        chmod +x scripts/check-secrets.sh
        chmod +x scripts/check-credentials.sh
        
    - name: Check for committed secrets
      run: |
        echo "üîí V√©rification des secrets dans le repository..."
        ./scripts/check-secrets.sh
        
    - name: Check credentials structure
      run: |
        echo "üîê V√©rification de la structure des credentials..."
        ./scripts/check-credentials.sh || echo "‚ö†Ô∏è Credentials non configur√©s (normal en CI)"
        
    - name: Validate .gitignore
      run: |
        echo "üìã V√©rification de .gitignore..."
        if ! grep -q "*.json" .gitignore; then
          echo "‚ùå .gitignore ne contient pas '*.json'"
          exit 1
        fi
        if ! grep -q "keys/" .gitignore; then
          echo "‚ùå .gitignore ne contient pas 'keys/'"
          exit 1
        fi
        if ! grep -q ".env" .gitignore; then
          echo "‚ùå .gitignore ne contient pas '.env'"
          exit 1
        fi
        echo "‚úÖ .gitignore correctement configur√©"
        
    - name: Check for sensitive patterns
      run: |
        echo "üîç Recherche de patterns sensibles..."
        
        # V√©rifier qu'il n'y a pas de cl√©s priv√©es
        if grep -r "-----BEGIN PRIVATE KEY-----" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=vendor --exclude="*.md" --exclude="check-secrets.sh" 2>/dev/null; then
          echo "‚ùå Cl√©s priv√©es trouv√©es dans le code"
          exit 1
        fi
        
        # V√©rifier qu'il n'y a pas de secrets dans les fichiers
        if grep -r "client_secret" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=vendor --exclude="*.md" --exclude="check-secrets.sh" 2>/dev/null; then
          echo "‚ùå Secrets trouv√©s dans le code"
          exit 1
        fi
        
        # V√©rifier qu'il n'y a pas de tokens
        if grep -r "refresh_token" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=vendor --exclude="*.md" --exclude="check-secrets.sh" 2>/dev/null; then
          echo "‚ùå Tokens trouv√©s dans le code"
          exit 1
        fi
        
        echo "‚úÖ Aucun pattern sensible trouv√©"
        
    - name: Validate environment files
      run: |
        echo "üìÑ V√©rification des fichiers d'environnement..."
        
        # V√©rifier que .env.example existe
        if [ ! -f ".env.example" ]; then
          echo "‚ùå .env.example manquant"
          exit 1
        fi
        
        # V√©rifier que .env.example ne contient pas de secrets
        if grep -q "sk-" .env.example 2>/dev/null; then
          echo "‚ùå .env.example contient des secrets"
          exit 1
        fi
        
        # V√©rifier que .env.example contient les variables n√©cessaires
        if ! grep -q "GOOGLE_APPLICATION_CREDENTIALS" .env.example; then
          echo "‚ùå .env.example ne contient pas GOOGLE_APPLICATION_CREDENTIALS"
          exit 1
        fi
        
        echo "‚úÖ Fichiers d'environnement corrects"
        
    - name: Check documentation
      run: |
        echo "üìö V√©rification de la documentation..."
        
        # V√©rifier que README.md existe
        if [ ! -f "README.md" ]; then
          echo "‚ùå README.md manquant"
          exit 1
        fi
        
        # V√©rifier que README.md contient des informations sur les credentials
        if ! grep -q -i "credential" README.md; then
          echo "‚ùå README.md ne contient pas d'informations sur les credentials"
          exit 1
        fi
        
        echo "‚úÖ Documentation pr√©sente"
        
    - name: Security summary
      run: |
        echo "üéâ V√©rification de s√©curit√© termin√©e avec succ√®s !"
        echo "   - Aucun secret expos√©"
        echo "   - .gitignore correctement configur√©"
        echo "   - Fichiers d'environnement s√©curis√©s"
        echo "   - Documentation pr√©sente"
        echo "   - Repository s√©curis√©"
