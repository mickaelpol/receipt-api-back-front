name: Credentials Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  credentials-tests:
    runs-on: ubuntu-latest
    
    services:
      nginx:
        image: nginx:alpine
        ports:
          - 8080:80
        volumes:
          - ./infra/nginx.conf:/etc/nginx/nginx.conf:ro
          - ./frontend:/usr/share/nginx/html:ro
          - ./backend:/var/www/html:ro
        options: >-
          --health-cmd "curl -f http://localhost:8080/api/health || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 3
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: json, curl, gd, zip
        tools: composer
        
    - name: Install dependencies
      run: |
        cd backend
        composer install --no-dev --optimize-autoloader
        
    - name: Make scripts executable
      run: |
        chmod +x scripts/*.sh
        
    - name: Wait for services
      run: |
        echo "⏳ Attente du démarrage des services..."
        sleep 10
        
    - name: Test health endpoints
      run: |
        echo "🏥 Test des endpoints de santé..."
        ./scripts/test-health.sh
        
    - name: Test credential validation
      run: |
        echo "🔐 Test de validation des credentials..."
        ./scripts/test-credential-failures.sh
        
    - name: Test API error handling
      run: |
        echo "🔌 Test de gestion des erreurs API..."
        ./scripts/test-api-errors.sh
        
    - name: Test credential integration
      run: |
        echo "🔗 Test d'intégration des credentials..."
        ./scripts/test-credential-integration.sh
        
    - name: Test credential security
      run: |
        echo "🔒 Test de sécurité des credentials..."
        ./scripts/test-credential-security.sh
        
    - name: Test credential compliance
      run: |
        echo "📋 Test de conformité des credentials..."
        ./scripts/test-credential-compliance.sh
        
    - name: Test credential monitoring
      run: |
        echo "📊 Test de monitoring des credentials..."
        ./scripts/test-credential-monitoring.sh
        
    - name: Test credential performance
      run: |
        echo "⚡ Test de performance des credentials..."
        ./scripts/test-credential-performance.sh
        
    - name: Test credential reliability
      run: |
        echo "🛡️ Test de fiabilité des credentials..."
        ./scripts/test-credential-reliability.sh
        
    - name: Test credential documentation
      run: |
        echo "📚 Test de documentation des credentials..."
        ./scripts/test-credential-documentation.sh
        
    - name: Run comprehensive tests
      run: |
        echo "🧪 Exécution des tests complets..."
        ./scripts/test-all.sh
        
    - name: Test results summary
      run: |
        echo "🎉 Tous les tests de credentials ont été exécutés !"
        echo "   - Endpoints de santé: ✅"
        echo "   - Validation des credentials: ✅"
        echo "   - Gestion des erreurs: ✅"
        echo "   - Intégration: ✅"
        echo "   - Sécurité: ✅"
        echo "   - Conformité: ✅"
        echo "   - Monitoring: ✅"
        echo "   - Performance: ✅"
        echo "   - Fiabilité: ✅"
        echo "   - Documentation: ✅"
