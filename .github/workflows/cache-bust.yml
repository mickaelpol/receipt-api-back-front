name: Cache-busting automatique

on:
  # D√©clench√© manuellement
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement cible'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      force:
        description: 'Forcer le cache-busting m√™me sans changements'
        required: false
        default: false
        type: boolean

  # D√©clench√© sur modification des assets
  push:
    paths:
      - 'frontend/assets/**'
      - 'frontend/index.html'
    branches: [ main, staging ]

jobs:
  cache-bust:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Cache-busting automatique
        run: |
          echo "üîÑ Cache-busting automatique..."
          chmod +x scripts/cache-bust-safe.sh
          ./scripts/cache-bust-safe.sh
          
          echo "üìä V√©rification des changements:"
          git diff --name-only
          
          if git diff --quiet; then
            echo "‚ÑπÔ∏è  Aucun changement d√©tect√© dans les assets"
            if [ "${{ github.event.inputs.force }}" = "true" ]; then
              echo "‚ö†Ô∏è  Mode forc√© activ√© - commit m√™me sans changements"
            else
              echo "‚úÖ Aucune action n√©cessaire"
              exit 0
            fi
          else
            echo "‚úÖ Cache-busting appliqu√© avec succ√®s"
          fi

      - name: Commit et push des changements
        if: github.event_name == 'workflow_dispatch' || !git diff --quiet
        run: |
          ENV="${{ github.event.inputs.environment || 'auto' }}"
          
          # D√©terminer l'environnement bas√© sur la branche si non sp√©cifi√©
          if [ "$ENV" = "auto" ]; then
            if [ "${{ github.ref }}" = "refs/heads/main" ]; then
              ENV="production"
            elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
              ENV="staging"
            else
              ENV="development"
            fi
          fi
          
          echo "üéØ Environnement d√©tect√©: $ENV"
          
          git add frontend/index.html
          git commit -m "chore: cache-busting automatique pour $ENV [skip ci]" || echo "‚ÑπÔ∏è  Pas de commit n√©cessaire"
          
          # Push seulement si on a fait un commit
          if git log -1 --pretty=%B | grep -q "chore: cache-busting"; then
            git push origin ${{ github.ref_name }}
            echo "‚úÖ Changements pouss√©s vers ${{ github.ref_name }}"
          fi

      - name: Notifier le r√©sultat
        run: |
          if git log -1 --pretty=%B | grep -q "chore: cache-busting"; then
            echo "üéâ Cache-busting appliqu√© avec succ√®s !"
            echo "üìã Environnement: ${{ github.event.inputs.environment || 'auto' }}"
            echo "üåø Branche: ${{ github.ref_name }}"
          else
            echo "‚ÑπÔ∏è  Aucun changement n√©cessaire"
          fi
