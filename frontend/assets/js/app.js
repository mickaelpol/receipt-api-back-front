(()=>{let e=(localStorage.getItem('BACK_BASE')||'').trim();if(!e){const t=location.hostname;e=t.endsWith('run.app')||t.endsWith('appspot.com')?location.origin:'http://localhost:8080';}window.BACK_BASE=e;})();const BACK_BASE=window.BACK_BASE;let CLIENT_ID=null,DEFAULT_SHEET=null,RECEIPT_API_URL=null,WHO_OPTIONS=[],accessToken=null,tokenClient=null,gisReady=!1,gapiReady=!1,currentUserEmail=null,_previewUrl=null,pendingSingleFile=null,pendingBatchAnalysis=!1;async function requestNotificationPermission(){return'Notification'in window&&('granted'===Notification.permission||'denied'!==Notification.permission&&'granted'===await Notification.requestPermission());}function sendNotification(e,t,n=null){if('Notification'in window&&'granted'===Notification.permission)try{const a=new Notification(e,{ body:t,icon:n||'/favicon.ico',badge:n||'/favicon.ico',vibrate:[200,100,200],tag:'receipt-analysis',renotify:!0 });setTimeout(()=>a.close(),5e3),a.onclick=()=>{window.focus(),a.close();};}catch(e){console.error('[Notification] Erreur:',e);}}const LS_TOKEN_EXP='gis_access_token_exp',LS_ACCOUNT_HINT='gis_account_hint';let MAX_UPLOADS=10;'serviceWorker'in navigator&&window.addEventListener('load',()=>{navigator.serviceWorker.register('/service-worker.js').then(e=>{e.scope,e.addEventListener('updatefound',()=>{const t=e.installing;t.addEventListener('statechange',()=>{'installed'===t.state&&navigator.serviceWorker.controller;});});}).catch(e=>{console.error('❌ Service Worker registration failed:',e);});});class UploadQueue{constructor(){this.dbName='scan2sheet-queue',this.storeName='pending-uploads',this.db=null;}async init(){return new Promise((e,t)=>{const n=indexedDB.open(this.dbName,1);n.onerror=()=>t(n.error),n.onsuccess=()=>{this.db=n.result,e();},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.storeName)||t.createObjectStore(this.storeName,{ keyPath:'id',autoIncrement:!0 }).createIndex('status','status',{ unique:!1 });};});}async add(e){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([this.storeName],'readwrite').objectStore(this.storeName),s={ ...e,timestamp:Date.now(),status:'pending',retries:0 },i=a.add(s);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error);});}async getPending(){return this.db||await this.init(),new Promise((e,t)=>{const n=this.db.transaction([this.storeName],'readonly').objectStore(this.storeName).index('status').getAll('pending');n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error);});}async update(e,t,n={}){return this.db||await this.init(),new Promise((a,s)=>{const i=this.db.transaction([this.storeName],'readwrite').objectStore(this.storeName),o=i.get(e);o.onsuccess=()=>{const e=o.result;if(!e)return s(new Error('Not found'));const r={ ...e,...n,status:t,updatedAt:Date.now() },c=i.put(r);c.onsuccess=()=>a(r),c.onerror=()=>s(c.error);},o.onerror=()=>s(o.error);});}async remove(e){return this.db||await this.init(),new Promise((t,n)=>{const a=this.db.transaction([this.storeName],'readwrite').objectStore(this.storeName).delete(e);a.onsuccess=()=>t(),a.onerror=()=>n(a.error);});}async getStats(){return this.db||await this.init(),new Promise((e,t)=>{const n=this.db.transaction([this.storeName],'readonly').objectStore(this.storeName).getAll();n.onsuccess=()=>{const t=n.result;e({ total:t.length,pending:t.filter(e=>'pending'===e.status).length,completed:t.filter(e=>'completed'===e.status).length,failed:t.filter(e=>'failed'===e.status).length });},n.onerror=()=>t(n.error);});}}const uploadQueue=new UploadQueue;async function syncPendingUploads(){try{const e=await uploadQueue.getPending();if(0===e.length)return;e.length,showToast(`📤 Envoi de ${e.length} ticket(s) en attente...`);let t=0,n=0;for(const a of e)try{await uploadQueue.update(a.id,'processing');const e=await fetch(`${BACK_BASE}/api/scan`,{ method:'POST',headers:{ 'Content-Type':'application/json',Authorization:`Bearer ${accessToken}` },body:JSON.stringify({ imageBase64:a.imageBase64 }) });if(!e.ok)throw new Error('Scan failed');const n=await e.json(),s=await api('/api/sheets/write',{ method:'POST',body:{ sheetName:a.sheetName,who:a.who,supplier:n.supplier_name||'',dateISO:n.receipt_date||'',total:n.total_amount||0 } });if(!s.ok)throw new Error('Write failed');await uploadQueue.update(a.id,'completed',{ result:s }),t++;}catch(e){const t=(a.retries||0)+1;t>=3?await uploadQueue.update(a.id,'failed',{ error:e.message,retries:t }):await uploadQueue.update(a.id,'pending',{ error:e.message,retries:t }),n++;}t>0&&showToast(`✅ ${t} ticket(s) envoyé(s) !`),n>0&&showToast(`⚠️ ${n} ticket(s) en erreur`);}catch(e){console.error('[Queue] Sync failed:',e);}}window.addEventListener('online',()=>{showToast('📶 Connexion rétablie - Analyse en cours...'),setTimeout(async()=>{try{let e=!1;if(pendingSingleFile&&(await analyzeSingleFile(pendingSingleFile),pendingSingleFile=null,sendNotification('✅ Analyse terminée','Votre ticket est prêt à être vérifié et enregistré'),e=!0),pendingBatchAnalysis&&multiItems.length>0){const t=multiItems.length;await runBatchScan(),pendingBatchAnalysis=!1,e||sendNotification('✅ Analyse terminée',`${t} ticket(s) prêt(s) à être vérifiés et enregistrés`);}}catch(e){console.error('[Offline] Analysis error:',e),sendNotification('❌ Erreur d\'analyse','Une erreur est survenue lors de l\'analyse des tickets');}},1e3);}),window.addEventListener('offline',()=>{showToast('📴 Hors ligne - Analyse au retour en ligne');}),window.addEventListener('load',()=>{uploadQueue.init().then(()=>{navigator.onLine&&syncPendingUploads();});});const $=e=>document.querySelector(e),setStatus=e=>{const t=$('#status');t&&(e.includes('<span')?t.innerHTML=e:t.textContent=e);},enableSave=e=>{const t=$('#btnSave');t&&(t.disabled=!e||!isUserAuthorized());};function updateFileInputsState(){const e=$('#file'),t=$('#multiFiles');e&&(e.disabled=!isUserAuthorized()),t&&(t.disabled=!isUserAuthorized());}const TOAST_DURATION=3e3,SERVICE_MONITOR_INTERVAL=1e4;let serviceMonitorInterval=null;function updateServiceStatus(e,t,n,a=''){const s=document.getElementById(e);s&&(t?(s.className='badge bg-success',s.textContent=`● ${n}`,s.title=a||('healthStatus'===e?'Application':'Services')+' opérationnel'):(s.className='badge bg-danger',s.textContent=`● ${n}`,s.title=a||('healthStatus'===e?'Application':'Services')+' hors service'));}async function checkService(e,t){try{const n=await fetch(`${BACK_BASE}${e}`,{ method:'GET',cache:'no-store' });if(n.ok){const a=await n.json();const s=a.status||'OK';let i='';'/health'===e?i=`Application en vie - ${a.timestamp||'maintenant'}`:'/ready'===e&&(i='PHP + DocAI + Credentials OK',a.credentials&&(i+=` (${a.credentials.project_id||'GCP'})`),a.timestamp&&(i+=` - ${a.timestamp}`)),updateServiceStatus(t,!0,s,i);}else{const e=await n.text();let a=`HTTP ${n.status}`;try{const t=JSON.parse(e);t.error&&(a+=`: ${t.error}`);}catch(t){a+=`: ${e.substring(0,50)}`;}updateServiceStatus(t,!1,'Error',a);}}catch(e){updateServiceStatus(t,!1,'Offline',`Connexion impossible: ${e.message}`);}}async function checkAllServices(){await Promise.all([checkService('/health','healthStatus'),checkService('/ready','readyStatus')]);}function startServiceMonitoring(){serviceMonitorInterval&&clearInterval(serviceMonitorInterval),checkAllServices(),serviceMonitorInterval=setInterval(checkAllServices,1e4);}function stopServiceMonitoring(){serviceMonitorInterval&&(clearInterval(serviceMonitorInterval),serviceMonitorInterval=null);}function simulateServiceFailure(e){'healthStatus'===e?updateServiceStatus('healthStatus',!1,'Error','Simulation: Application hors service'):'readyStatus'===e&&updateServiceStatus('readyStatus',!1,'Error','Simulation: DocAI inaccessible');}function simulateServiceRecovery(e){'healthStatus'===e?updateServiceStatus('healthStatus',!0,'alive','Simulation: Application récupérée'):'readyStatus'===e&&updateServiceStatus('readyStatus',!0,'ready','Simulation: Services récupérés');}function testAllErrorScenarios(){setTimeout(()=>{simulateServiceFailure('healthStatus');},1e3),setTimeout(()=>{simulateServiceFailure('readyStatus');},2e3),setTimeout(()=>{simulateServiceRecovery('healthStatus');},5e3),setTimeout(()=>{simulateServiceRecovery('readyStatus');},7e3),setTimeout(()=>{startServiceMonitoring();},1e4);}function ensureToastStyles(){if(document.getElementById('tiny-toast-css'))return;const e=document.createElement('style');e.id='tiny-toast-css',e.textContent='\n  .tiny-toast-wrap {\n    position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);\n    z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none;\n  }\n  .tiny-toast {\n    display: inline-flex; align-items: center; gap: 8px;\n    background: linear-gradient(180deg, #FFF8DB, #FFE9A8);\n    color: #5C4400; border: 1px solid #F6C552;\n    border-radius: 10px; padding: 10px 14px;\n    box-shadow: 0 6px 18px rgba(0,0,0,.12);\n    font-size: 14px; max-width: 92vw; pointer-events: auto;\n    transition: opacity .2s ease, transform .2s ease; opacity: 0; transform: translateY(6px);\n  }\n  .tiny-toast::before { content: "⚠️"; }\n  .tiny-toast.show { opacity: 1; transform: translateY(0); }\n  .tiny-toast.hide { opacity: 0; transform: translateY(6px); }\n  @media (prefers-color-scheme: dark) {\n    .tiny-toast { background: linear-gradient(180deg, #3A3205, #4A3E07); color: #FFE9A8; border-color: #8A6B02; }\n  }',document.head.appendChild(e);}function showToast(e){ensureToastStyles();let t=document.getElementById('tiny-toast-wrap');t||(t=document.createElement('div'),t.id='tiny-toast-wrap',t.className='tiny-toast-wrap',document.body.appendChild(t));const n=document.createElement('div');n.className='tiny-toast',n.textContent=e,t.appendChild(n),requestAnimationFrame(()=>n.classList.add('show')),setTimeout(()=>{n.classList.remove('show'),n.classList.add('hide'),setTimeout(()=>n.remove(),220);},TOAST_DURATION);}function storeToken(e,t){accessToken=e;try{if(sessionStorage.setItem('wasAuthenticated','true'),t){const e=Date.now()+1e3*t;localStorage.setItem(LS_TOKEN_EXP,e.toString());}}catch{}}function loadValidToken(){try{if(sessionStorage.getItem('wasAuthenticated')&&accessToken){const e=localStorage.getItem(LS_TOKEN_EXP);return e&&Date.now()>parseInt(e)?(clearStoredToken(),null):accessToken;}}catch{}return null;}function clearStoredToken(){accessToken=null;try{sessionStorage.removeItem('wasAuthenticated'),localStorage.removeItem(LS_TOKEN_EXP);}catch{}}function storeAccountHint(e){try{e&&localStorage.setItem(LS_ACCOUNT_HINT,e);}catch{}}function loadAccountHint(){try{return localStorage.getItem(LS_ACCOUNT_HINT)||'';}catch{return'';}}async function encodeForDocAI(e){const t=e.size/1048576;if(e.name,t.toFixed(2),e.type,t<1)return await fileToBase64NoPrefix(e);if(t<3){const t=await smartCompress(e,{ maxLongSide:3e3,quality:.92,targetSizeMB:2 });return logCompressionStats(e.size,t.sizeBytes,t.dimensions),t.base64;}if(t<5){const t=await smartCompress(e,{ maxLongSide:2400,quality:.88,targetSizeMB:1.5 });return logCompressionStats(e.size,t.sizeBytes,t.dimensions),t.base64;}if(t<10){const t=await smartCompress(e,{ maxLongSide:2e3,quality:.85,targetSizeMB:1 });return logCompressionStats(e.size,t.sizeBytes,t.dimensions),t.base64;}const n=await progressiveCompress(e);return logCompressionStats(e.size,n.sizeBytes,n.dimensions),n.base64;}function logCompressionStats(e,t,n){const a=e/1048576,s=t/1048576;(100*(1-t/e)).toFixed(1),a.toFixed(2),s.toFixed(2),n.w,n.h;}async function smartCompress(e,t){const{ maxLongSide:n,quality:a,targetSizeMB:s }=t,i='image/png'===e.type?'image/jpeg':e.type,{ img:o,url:r }=await loadImageURL(URL.createObjectURL(e)),c=Math.max(o.naturalWidth||o.width,o.naturalHeight||o.height),l=Math.min(1,n/c),u=Math.round((o.naturalWidth||o.width)*l),d=Math.round((o.naturalHeight||o.height)*l),h=document.createElement('canvas');h.width=u,h.height=d;const m=h.getContext('2d');m.imageSmoothingEnabled=!0,m.imageSmoothingQuality='high',m.drawImage(o,0,0,u,d);let p=h.toDataURL(i,a),g=Math.round(3*p.length/4),S=a;const f=1024*s*1024;let y=0;for(;g>f&&S>.5&&y<5;)S-=.05,p=h.toDataURL(i,S),g=Math.round(3*p.length/4),y++,S.toFixed(2),(g/1048576).toFixed(2);return URL.revokeObjectURL(r),{ base64:p.split(',')[1],sizeBytes:g,dimensions:{ w:u,h:d } };}async function progressiveCompress(e){let t=await smartCompress(e,{ maxLongSide:1800,quality:.82,targetSizeMB:.8 });return t.sizeBytes>1572864&&(t=await smartCompress(e,{ maxLongSide:1600,quality:.75,targetSizeMB:.6 })),t.sizeBytes>1258291.2&&(t=await smartCompress(e,{ maxLongSide:1400,quality:.7,targetSizeMB:.5 })),t;}function resetFileInput(){const e=document.getElementById('file');if(!e)return;try{e.value='';}catch{}const t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener('change',onImagePicked);}function setAuthStatus(e,t=null){const n=$('#authStatus');n&&(n.textContent=e,n.classList.remove('text-muted','text-success','text-danger'),n.style.removeProperty('color'),!0===t?(n.classList.add('text-success'),n.style.setProperty('color','#28a745','important')):!1===t&&(n.classList.add('text-danger'),n.style.setProperty('color','#dc3545','important')));}'undefined'!=typeof window&&(window.simulateServiceFailure=simulateServiceFailure,window.simulateServiceRecovery=simulateServiceRecovery,window.testAllErrorScenarios=testAllErrorScenarios,window.checkAllServices=checkAllServices);const showAuthButton=()=>{const e=$('#btnAuth');e&&(e.style.display='inline-block');},hideAuthButton=()=>{const e=$('#btnAuth');e&&(e.style.display='none');},showSwitchButton=()=>{const e=$('#btnSwitch');e&&(e.style.display='inline-block');},hideSwitchButton=()=>{const e=$('#btnSwitch');e&&(e.style.display='none');},hideAuthStatus=()=>{const e=$('#authStatus');e&&(e.style.display='none');},showAuthStatus=()=>{const e=$('#authStatus');e&&(e.style.display='inline');};let hasAuthError=!1;function isUserAuthorized(){return currentUserEmail&&!hasAuthError;}function checkAuthorization(e='cette action'){return!!isUserAuthorized()||(setAnalysisStatus(`❌ Compte non autorisé - ${e} bloquée`,'#dc3545'),!1);}function setAnalysisStatus(e,t='#666'){let n=document.getElementById('analysisStatus');if(!n){n=document.createElement('div'),n.id='analysisStatus',n.style.fontSize='0.9em',n.style.marginTop='5px';const e=document.getElementById('status');e&&e.parentNode&&e.parentNode.insertBefore(n,e.nextSibling);}n.style.color=t,n.textContent=e,n.style.display=e?'block':'none';}function clearAnalysisStatus(){setAnalysisStatus('');}function setMultiAnalysisStatus(e,t='#666'){const n=document.getElementById('multiAnalysisStatus');n&&(n.style.backgroundColor=t+'20',n.style.color=t,n.style.borderLeft=`4px solid ${t}`,n.textContent=e,n.style.display=e?'block':'none');}function clearMultiAnalysisStatus(){setMultiAnalysisStatus('');}function clearSheetsSelect(e=''){const t=$('#sheetSelect');t&&(t.innerHTML=e?`<option disabled selected>${e}</option>`:'');}function needAuthUI(e='Veuillez vous connecter.'){showAuthButton(),hideSwitchButton(),showAuthStatus(),setAuthStatus(e,!1),enableSave(!1),clearSheetsSelect('Feuilles indisponibles');}function neutralAuthUI(e='Connexion…'){showAuthButton(),hideSwitchButton(),showAuthStatus(),setAuthStatus(e,null),enableSave(!1);}async function api(e,{ method:t='GET',headers:n={},body:a=null }={}){const s=e.startsWith('/api/')&&!e.startsWith('/api/config'),i={ Accept:'application/json','Content-Type':'application/json',...n };if(s){if(!accessToken)try{if(await ensureConnected(!1),!accessToken)throw new Error('Token absent après ensureConnected');}catch{throw new Error('Connexion requise');}i.Authorization=`Bearer ${accessToken}`;}const o=await fetch(`${BACK_BASE}${e}`,{ method:t,headers:i,body:a?'string'==typeof a?a:JSON.stringify(a):null,credentials:'omit',cache:'no-store' }),r=await o.text();let c;try{c=JSON.parse(r);}catch{c=null;}if(!o.ok){if(401===o.status&&s){try{if(accessToken=null,clearStoredToken(),await ensureConnected(!1),accessToken){i.Authorization=`Bearer ${accessToken}`;const n=await fetch(`${BACK_BASE}${e}`,{ method:t,headers:i,body:a?'string'==typeof a?a:JSON.stringify(a):null,credentials:'omit',cache:'no-store' }),s=await n.text();let o;try{o=JSON.parse(s);}catch{o=null;}if(n.ok)return o??s;}}catch{}throw showToast('Session expirée — veuillez vous reconnecter'),needAuthUI('Session expirée'),new Error('Session expirée');}throw new Error(c?.error||`HTTP ${o.status}`);}return c??r;}function syncPreviewHeight(){const e=$('#formCol'),t=$('#previewWrap');if(!e||!t)return;const n=Math.round(e.getBoundingClientRect().height),a=Math.round(.75*window.innerHeight),s=Math.max(160,Math.min(n,a));t.style.setProperty('--preview-h',`${s}px`);}function setPreview(e){const t=$('#previewWrap'),n=$('#preview');if(n&&t){if(_previewUrl&&(URL.revokeObjectURL(_previewUrl),_previewUrl=null),!e)return n.removeAttribute('src'),t.classList.remove('has-image'),void syncPreviewHeight();_previewUrl=e,n.onload=()=>{syncPreviewHeight();},n.src=_previewUrl,t.classList.add('has-image');}}function applyAuthStack(){const e=document.getElementById('authStatus');if(!e)return;const t=e.parentElement;t&&(window.matchMedia('(max-width: 992px)').matches?t.classList.add('auth-stack'):t.classList.remove('auth-stack'));}async function init(){try{neutralAuthUI('Connexion…'),currentUserEmail||setStatus('Initialisation...'),await loadConfig(),bindUI(),await bootGoogle(),currentUserEmail||setStatus('Connexion...'),await autoSignIn(),syncPreviewHeight(),initMultiUIGrid(),setupFloatingActions(),renderMultiEmptyIfNeeded(),startServiceMonitoring(),setTimeout(()=>{requestNotificationPermission().then(e=>{});},2e3);}catch{currentUserEmail||setStatus('Config indisponible'),needAuthUI('Erreur de configuration');}}async function loadConfig(){const e=new URL(`${BACK_BASE}/api/config`);e.searchParams.set('t',String(Date.now()));const t=await fetch(e,{ cache:'no-store' }).then(e=>e.json());if(!t.ok)throw new Error(t.error||'Config error');CLIENT_ID=t.client_id||null,DEFAULT_SHEET=t.default_sheet||'Feuille 1',RECEIPT_API_URL=t.receipt_api_url||`${BACK_BASE}/api/scan`,MAX_UPLOADS=Number.isFinite(t.max_batch)?Number(t.max_batch):10,WHO_OPTIONS=Array.isArray(t.who_options)?t.who_options:[],renderWhoOptions(WHO_OPTIONS);}function bindUI(){$('#file')?.addEventListener('change',onImagePicked),$('#btnSave')?.addEventListener('click',saveToSheet),$('#btnReset')?.addEventListener('click',resetForm),$('#btnAuth')?.addEventListener('click',async()=>{try{neutralAuthUI('Connexion…'),await ensureConnected(!0),await afterSignedIn(),setStatus(`<span style="color: #28a745; font-weight: bold;">●</span> Connecté - ${currentUserEmail}`),clearAnalysisStatus(),hideAuthStatus(),hasAuthError=!1,updateFileInputsState();}catch(e){handleAuthError(e);}}),$('#btnSwitch')?.addEventListener('click',switchAccount),hideSwitchButton(),$('#total')?.addEventListener('blur',()=>{const e=parseEuroToNumber($('#total').value);null!=e&&($('#total').value=e.toFixed(2).replace('.',',')),validateCanSave();}),['merchant','date','total'].forEach(e=>$('#'+e)?.addEventListener('input',validateCanSave)),$('#modeToggle')?.addEventListener('change',e=>{switchMode(e.target.checked?'multi':'single');}),$('#multiFiles')?.addEventListener('change',onMultiFilesPicked),switchMode('single');}document.addEventListener('DOMContentLoaded',init),window.addEventListener('resize',()=>syncPreviewHeight()),window.addEventListener('resize',applyAuthStack),document.addEventListener('DOMContentLoaded',applyAuthStack),window.addEventListener('beforeunload',stopServiceMonitoring);const LS_WHO='scan_who_last',slug=e=>String(e||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/gi,'-').replace(/^-+|-+$/g,'').toLowerCase();function renderWhoOptions(e=[]){const t=document.getElementById('whoGroup');if(!t)return;if(!Array.isArray(e)||0===e.length)return void(t.innerHTML='<span class="subtle">Aucun profil configuré.</span>');const n=localStorage.getItem(LS_WHO),a=e.includes(n)?n:e[0];t.classList.add('seg'),t.innerHTML=e.map(e=>{const t=`whoTop-${slug(e)}`;return`\n      <input type="radio" name="whoTop" id="${t}" value="${e}" ${e===a?'checked':''}>\n      <label for="${t}">${e}</label>\n    `;}).join(''),t.addEventListener('change',()=>{const e=document.querySelector('input[name="whoTop"]:checked')?.value||'';e&&localStorage.setItem(LS_WHO,e),validateCanSave();});}function resetForm(){['merchant','date','total'].forEach(e=>{const t=$('#'+e);t&&(t.value='');}),setPreview(null),resetFileInput(),enableSave(!1),clearAnalysisStatus(),currentUserEmail||hasAuthError||setStatus('<span style="color: #28a745; font-weight: bold;">●</span> Connecté.');}function parseEuroToNumber(e){if(!e)return null;const t=parseFloat(String(e).replace(/\s+/g,'').replace(/[€]/g,'').replace(',','.'));return Number.isFinite(t)?t:null;}function validateCanSave(){const e=($('#merchant')?.value||'').trim(),t=!!$('#date')?.value,n=null!=parseEuroToNumber($('#total')?.value),a=!!$('#sheetSelect')?.value,s=document.querySelector('input[name="whoTop"]:checked')?.value||'';enableSave(!!e&&t&&n&&a&&!!currentUserEmail&&!!s);}async function bootGoogle(){CLIENT_ID||setStatus('CLIENT_ID manquant'),await waitFor(()=>window.google?.accounts?.oauth2,150,1e4).catch(()=>{}),window.google?.accounts?.oauth2&&CLIENT_ID&&(tokenClient=google.accounts.oauth2.initTokenClient({ client_id:CLIENT_ID,scope:'openid email profile',prompt:'',callback:e=>{e&&!e.error&&(accessToken=e.access_token,e.expires_in&&storeToken(accessToken,Number(e.expires_in)));} }),gisReady=!0),await waitFor(()=>'undefined'!=typeof gapi,150,1e4).catch(()=>{}),'undefined'!=typeof gapi&&(await new Promise(e=>gapi.load('client',e)),await gapi.client.init({ discoveryDocs:['https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest'] }),gapiReady=!0);}async function autoSignIn(){try{const e=loadValidToken();if(e)return accessToken=e,await afterSignedIn(),setStatus(`<span style="color: #28a745; font-weight: bold;">●</span> Connecté - ${currentUserEmail}`),clearAnalysisStatus(),hideAuthStatus(),hasAuthError=!1,void updateFileInputsState();if(gisReady&&CLIENT_ID)try{return await ensureConnected(!1),await afterSignedIn(),setStatus(`<span style="color: #28a745; font-weight: bold;">●</span> Connecté - ${currentUserEmail}`),clearAnalysisStatus(),hideAuthStatus(),hasAuthError=!1,void updateFileInputsState();}catch{}needAuthUI('Veuillez vous connecter.');}catch(e){isUnauthorizedEmailError(e)?handleAuthError(e):needAuthUI('Veuillez vous connecter.');}}async function ensureConnected(e=!1){if(!gisReady)throw new Error('Google Identity non prêt');const t=loadValidToken();if(t)return void(accessToken=t);const n=loadAccountHint();accessToken=null,await new Promise((t,a)=>{tokenClient.callback=e=>{if(e?.error)return a(e);accessToken=e.access_token,e.expires_in&&storeToken(accessToken,Number(e.expires_in)),t();},tokenClient.requestAccessToken({ prompt:e?'consent':'',hint:n||void 0 });}).catch(async t=>{if(!(t&&(String(t.error).includes('consent')||String(t.error).includes('interaction'))||e))throw t;return new Promise((e,t)=>{tokenClient.callback=n=>{if(n?.error)return t(n);accessToken=n.access_token,n.expires_in&&storeToken(accessToken,Number(n.expires_in)),e();},tokenClient.requestAccessToken({ prompt:'consent',hint:n||void 0 });});});}async function afterSignedIn(){let e;try{e=await api('/api/auth/me');}catch(e){throw handleAuthError(e),e;}currentUserEmail=e.email||null,currentUserEmail&&storeAccountHint(currentUserEmail);try{if(gapiReady&&accessToken){gapi.client.setToken({ access_token:accessToken });const e=await gapi.client.oauth2.userinfo.get();currentUserEmail=(e.result?.email||currentUserEmail||'').toLowerCase(),currentUserEmail&&storeAccountHint(currentUserEmail);}}catch{}accessToken&&!loadValidToken()&&storeToken(accessToken,3300),currentUserEmail&&(setStatus(`<span style="color: #28a745; font-weight: bold;">●</span> Connecté - ${currentUserEmail}`),clearAnalysisStatus(),hideAuthButton(),hideAuthStatus(),showSwitchButton(),hasAuthError=!1,updateFileInputsState());try{await populateSheets();}catch(e){}validateCanSave(),syncPreviewHeight();}function isUnauthorizedEmailError(e){const t=String(e?.message||e||'');return/Email non autoris(é|e)/i.test(t)||/403/.test(t);}function handleAuthError(e,{ showButton:t=!0 }={}){const n=String(e?.message||'\'Erreur d\'authentification\'');signOutQuiet({ keepHint:!1 });const a=isUnauthorizedEmailError(e);setAuthStatus(a?n||'Email non autorisé':'Connexion requise.',!1),a&&(setStatus('<span style="color: #dc3545; font-weight: bold;">●</span> Email non autorisé'),showAuthStatus(),hasAuthError=!0),t?showAuthButton():hideAuthButton(),hideSwitchButton(),clearSheetsSelect('Feuilles indisponibles'),enableSave(!1),updateFileInputsState();}async function populateSheets(){const e=await api('/api/sheets'),t=(e.sheets||[]).sort((e,t)=>(e.index||0)-(t.index||0)),n=$('#sheetSelect');if(!n)return;n.innerHTML=t.map(e=>`<option>${e.title}</option>`).join('');const a=e.default_sheet||DEFAULT_SHEET,s=t.find(e=>e.title===a)||t.at(-1);s&&(n.value=s.title);}function waitFor(e,t=100,n=1e4){return new Promise((a,s)=>{const i=Date.now();!function o(){try{if(e())return a();}catch{}if(Date.now()-i>n)return s(new Error('waitFor timeout'));setTimeout(o,t);}();});}async function onImagePicked(e){const t=e.target.files?.[0];if(t)if(checkAuthorization('upload de photo')){if(!navigator.onLine)return pendingSingleFile=t,setPreview(URL.createObjectURL(t)),setAnalysisStatus('📴 Hors ligne - Analyse au retour en ligne','#ff8c00'),showToast('📴 Image enregistrée, analyse au retour en ligne'),void enableSave(!1);enableSave(!1),setAnalysisStatus('Analyse du ticket…','#007bff'),setPreview(URL.createObjectURL(t));try{accessToken||await ensureConnected(!1),await api('/api/auth/me');const e=await encodeForDocAI(t),n=await fetch(RECEIPT_API_URL,{ method:'POST',headers:{ 'Content-Type':'application/json',...accessToken?{ Authorization:`Bearer ${accessToken}` }:{} },body:JSON.stringify({ imageBase64:e }) }),a=await n.text();let s={};try{s=JSON.parse(a);}catch{}if(!n.ok||!1===s.ok)throw new Error(s.error||`HTTP ${n.status}`);s.supplier_name&&($('#merchant').value=s.supplier_name),s.receipt_date&&($('#date').value=s.receipt_date),null!=s.total_amount&&($('#total').value=Number(s.total_amount).toFixed(2).replace('.',',')),setAnalysisStatus('Reconnaissance OK. Vérifie puis « Enregistrer ».','#28a745');}catch(e){isUnauthorizedEmailError(e)?handleAuthError(e):setAnalysisStatus('Analyse indisponible — complète manuellement.','#dc3545');}finally{const e=document.getElementById('file');if(e)try{e.value='';}catch{}validateCanSave(),syncPreviewHeight();}}else e.target.value='';else setPreview(null);}function fileToBase64NoPrefix(e){return new Promise((t,n)=>{const a=new FileReader;a.onload=()=>{const e=String(a.result||'');t(e.includes(',')?e.split(',')[1]:e);},a.onerror=n,a.readAsDataURL(e);});}async function analyzeSingleFile(e){if(e){enableSave(!1),setAnalysisStatus('Analyse du ticket…','#007bff'),setPreview(URL.createObjectURL(e));try{accessToken||await ensureConnected(!1),await api('/api/auth/me');const t=await encodeForDocAI(e),n=await fetch(RECEIPT_API_URL,{ method:'POST',headers:{ 'Content-Type':'application/json',...accessToken?{ Authorization:`Bearer ${accessToken}` }:{} },body:JSON.stringify({ imageBase64:t }) }),a=await n.text();let s={};try{s=JSON.parse(a);}catch{}if(!n.ok||!1===s.ok)throw new Error(s.error||`HTTP ${n.status}`);s.supplier_name&&($('#merchant').value=s.supplier_name),s.receipt_date&&($('#date').value=s.receipt_date),null!=s.total_amount&&($('#total').value=Number(s.total_amount).toFixed(2).replace('.',',')),setAnalysisStatus('✅ Analyse terminée - Vérifiez les données puis cliquez sur "Enregistrer"','#28a745'),showToast('✅ Analyse terminée - Vérifiez avant d\'enregistrer');}catch(e){isUnauthorizedEmailError(e)?handleAuthError(e):setAnalysisStatus('Analyse indisponible — complète manuellement.','#dc3545');}finally{validateCanSave(),syncPreviewHeight();}}}async function saveToSheet(){if(checkAuthorization('enregistrement'))try{accessToken||await ensureConnected(!1),await api('/api/auth/me');const e=$('#sheetSelect')?.value||DEFAULT_SHEET,t=document.querySelector('input[name="whoTop"]:checked')?.value||'',n=($('#merchant').value||'').trim(),a=$('#date').value,s=parseEuroToNumber($('#total').value);if(!(n&&a&&null!=s&&e&&t))throw new Error('Champs incomplets');setAnalysisStatus('Écriture…','#007bff');const i=await api('/api/sheets/write',{ method:'POST',headers:{ 'Content-Type':'application/json' },body:JSON.stringify({ sheetName:e,who:t,supplier:n,dateISO:a,total:s }) });if(!i.ok)throw new Error(i.error||'Échec écriture');setAnalysisStatus(`Enregistré ✔ (onglet « ${e} », ${t})`,'#28a745'),enableSave(!1);}catch(e){isUnauthorizedEmailError(e)?handleAuthError(e):setAnalysisStatus('Erreur : '+(e.message||e),'#dc3545');}}async function revokeAccessToken(e){if(e)try{await fetch('https://oauth2.googleapis.com/revoke?token='+encodeURIComponent(e),{ method:'POST',headers:{ 'Content-Type':'application/x-www-form-urlencoded' } });}catch{}}function signOutQuiet({ keepHint:e=!0 }={}){if(accessToken&&revokeAccessToken(accessToken),clearStoredToken(),!e)try{localStorage.removeItem(LS_ACCOUNT_HINT);}catch{}accessToken=null,currentUserEmail=null,hideSwitchButton(),clearSheetsSelect('Feuilles indisponibles'),enableSave(!1);}async function switchAccount(){try{signOutQuiet({ keepHint:!1 }),hideAuthButton(),hideSwitchButton(),clearSheetsSelect('Changement de compte…'),setAuthStatus('Changement de compte…',null),setStatus('<span style="color: #ff8c00; font-weight: bold;">●</span> Changement de compte...'),await new Promise((e,t)=>{tokenClient.callback=n=>{if(n?.error)return t(n);accessToken=n.access_token,n.expires_in&&storeToken(accessToken,Number(n.expires_in)),e();},tokenClient.requestAccessToken({ prompt:'select_account' });}),await afterSignedIn(),setStatus('<span style="color: #28a745; font-weight: bold;">●</span> Connecté (compte changé)'),clearAnalysisStatus(),hideAuthButton(),hideAuthStatus(),showSwitchButton(),hasAuthError=!1,updateFileInputsState();}catch(e){isUnauthorizedEmailError(e)?handleAuthError(e,{ showButton:!0 }):needAuthUI('Veuillez vous connecter.');}}let multiItems=[];function initMultiUIGrid(){}let _fabMounted=!1,_fabSpacerEl=null,_fabAddLabel=null;function setupFloatingActions(){if(_fabMounted)return;if(!document.getElementById('multiFiles'))return;const e=document.createElement('div');e.className='fab-wrap',e.id='floatingActions',e.hidden=!0;const t=document.createElement('label');t.setAttribute('for','multiFiles'),t.className='fab-btn fab-add',t.title='Ajouter des photos',t.setAttribute('aria-label','Ajouter des photos'),t.innerHTML='<span class="fab-icon" aria-hidden="true">+</span>',_fabAddLabel=t;const n=document.createElement('button');n.id='btnBatchSave',n.className='fab-btn fab-save',n.title='Enregistrer tout',n.setAttribute('aria-label','Enregistrer tout'),n.innerHTML='<span class="fab-icon" aria-hidden="true">💾</span>',n.disabled=!0;const a=document.createElement('button');a.id='btnBatchReset',a.className='fab-btn fab-clear',a.title='Vider',a.setAttribute('aria-label','Vider'),a.innerHTML='<span class="fab-icon" aria-hidden="true">🗑️</span>',n.addEventListener('click',runBatchSave),a.addEventListener('click',clearMulti),e.appendChild(t),e.appendChild(n),e.appendChild(a),document.body.appendChild(e);const s=document.getElementById('multiCards');s&&!_fabSpacerEl&&(_fabSpacerEl=document.createElement('div'),_fabSpacerEl.className='fab-spacer',s.after(_fabSpacerEl));const i=()=>{if(!_fabSpacerEl)return;const t=e.getBoundingClientRect().height||76;_fabSpacerEl.style.height=`${Math.ceil(t+12)}px`;};i(),window.addEventListener('resize',i),new ResizeObserver(i).observe(e),_fabMounted=!0;}function showFloatingActions(e){const t=document.getElementById('floatingActions');t&&(t.hidden=!e);}function renderMultiEmptyIfNeeded(){const e=document.getElementById('multiCards');if(!e)return;let t=document.getElementById('multiEmpty');0===multiItems.length?t||(t=document.createElement('div'),t.id='multiEmpty',t.innerHTML=`\n        <div class="inner">\n          <div class="emoji">🧾</div>\n          <div class="hint">Ajoute jusqu’à ${MAX_UPLOADS} tickets en une fois.<br>Conseil : vise bien le montant total sur la photo.</div>\n          <label class="btn btn-warning pick" for="multiFiles">📷 Ajouter des photos</label>\n        </div>`,e.before(t)):t&&t.remove();}function switchMode(e){const t=$('#singleSection'),n=$('#multiSection'),a=$('#modeToggle');'multi'===e?(a&&(a.checked=!0),t&&(t.style.display='none'),n&&(n.style.display=''),resetForm(),showFloatingActions(!0),renderMultiEmptyIfNeeded()):(a&&(a.checked=!1),t&&(t.style.display=''),n&&(n.style.display='none'),clearMulti(),showFloatingActions(!1));}async function onMultiFilesPicked(e){const t=Array.from(e.target.files||[]);if(!t.length)return;if(!checkAuthorization('upload multiple de photos')){try{e.target.value='';}catch{}return;}try{e.target.value='';}catch{}const n=Math.max(0,MAX_UPLOADS-multiItems.length);if(n<=0)return showToast(`Limite atteinte : ${MAX_UPLOADS} tickets max.`),setStatus(`Limite atteinte (${MAX_UPLOADS} tickets).`),void updateBatchButtons();const a=t.slice(0,n);a.length<t.length&&(showToast(`Seuls ${a.length}/${t.length} ajoutés (max ${MAX_UPLOADS}).`),setStatus(`Seuls ${a.length}/${t.length} ajoutés (max ${MAX_UPLOADS}).`));for(const e of a){const t='card_'+Math.random().toString(36).slice(2),n=URL.createObjectURL(e);multiItems.push({ id:t,file:e,thumbUrl:n,status:'En attente…',supplier:'',dateISO:'',total:null }),renderCard({ id:t,thumbUrl:n,status:'En attente…' });}renderMultiEmptyIfNeeded(),updateBatchButtons(),runBatchScan().catch(()=>{});}function renderCard(e){const t=$('#multiCards');if(!t)return;let n=document.getElementById(e.id);const a=String(e.status||'').toUpperCase(),s=a.startsWith('ANALY')?'status-analyse':'OK'===a?'status-ok':a?'status-error':'',i=`\n    <div class="card bg-dark text-white p-2" style="width:100%;max-width:100%;box-sizing:border-box;">\n      <div class="text-center mb-2">\n        <img src="${e.thumbUrl}" alt="" style="max-width:100%;height:auto;object-fit:contain;">\n      </div>\n\n      <div class="status-badge ${s}">${e.status||''}</div>\n\n      <div class="mb-2">\n        <label class="form-label small">Intitulé (enseigne)</label>\n        <input type="text" class="form-control form-control-sm" data-k="supplier" value="${e.supplier||''}">\n      </div>\n      <div class="mb-2">\n        <label class="form-label small">Date</label>\n        <input type="date" class="form-control form-control-sm" data-k="dateISO" value="${e.dateISO||''}">\n      </div>\n      <div class="mb-2">\n        <label class="form-label small">Total (€)</label>\n        <input type="text" inputmode="decimal" class="form-control form-control-sm" data-k="total" value="${null!=e.total?String(e.total):''}">\n      </div>\n    </div>\n  `;n||(n=document.createElement('div'),n.id=e.id,t.appendChild(n)),n.innerHTML=i,n.querySelectorAll('input[data-k]').forEach(t=>{t.addEventListener('input',()=>{const n=t.getAttribute('data-k'),a=multiItems.find(t=>t.id===e.id);a&&('total'===n?a.total=parseFloat(String(t.value).replace(',','.')):a[n]=t.value);});});}function clearMulti(){multiItems.forEach(e=>{e.thumbUrl&&URL.revokeObjectURL(e.thumbUrl);}),multiItems=[];const e=$('#multiCards');e&&(e.innerHTML=''),clearMultiAnalysisStatus(),renderMultiEmptyIfNeeded(),updateBatchButtons();}function loadImageURL(e){return new Promise((t,n)=>{const a=new Image;a.onload=()=>t({ img:a,url:e }),a.onerror=n,a.src=e;});}async function compressToBase64(e,t=2400,n=.96,a='image/jpeg'){const{ img:s,url:i }=await loadImageURL(URL.createObjectURL(e)),o=Math.max(s.naturalWidth||s.width,s.naturalHeight||s.height),r=Math.min(1,t/o),c=Math.round((s.naturalWidth||s.width)*r),l=Math.round((s.naturalHeight||s.height)*r),u=document.createElement('canvas');u.width=c,u.height=l;const d=u.getContext('2d');d.imageSmoothingEnabled=!0,d.imageSmoothingQuality='high',d.drawImage(s,0,0,c,l);const h=u.toDataURL(a,n);return URL.revokeObjectURL(i),h.split(',')[1];}function runWithConcurrency(e,t,n=3){return new Promise(a=>{let s=0,i=0;const o=[];!function r(){for(;i<n&&s<e.length;){const n=s++;i++,Promise.resolve(t(e[n],n)).then(e=>o[n]=e).catch(e=>o[n]={ ok:!1,error:String(e) }).finally(()=>{i--,o.length!==e.length||o.includes(void 0)?r():a(o);});}}();});}async function runBatchScan(){if(multiItems.length)if(navigator.onLine){$('#btnBatchScan')&&($('#btnBatchScan').disabled=!0),$('#btnBatchSave')&&($('#btnBatchSave').disabled=!0);try{accessToken||await ensureConnected(!1),await api('/api/auth/me');const e=multiItems.length;setMultiAnalysisStatus(`Analyse de ${e} ticket(s)...`,'#007bff');let t=0,n=0;const a=async(a,s)=>{const i=document.getElementById(a.id);a.status='Analyse…',i&&renderCard(a),setMultiAnalysisStatus(`Analyse ${s+1}/${e}...`,'#007bff');const o=await encodeForDocAI(a.file),r=await fetch(`${BACK_BASE}/api/scan`,{ method:'POST',headers:{ 'Content-Type':'application/json',Authorization:`Bearer ${accessToken}` },body:JSON.stringify({ imageBase64:o }) }),c=await r.json();if(!r.ok||!1===c.ok)throw n++,new Error(c.error||`HTTP ${r.status}`);return a.supplier=c.supplier_name||'',a.dateISO=c.receipt_date||'',a.total=null!=c.total_amount?Number(c.total_amount):null,a.status='OK',t++,renderCard(a),setMultiAnalysisStatus(`✓ ${s+1}/${e} : ${a.supplier||'Ticket'} analysé`,'#28a745'),{ ok:!0 };};await runWithConcurrency(multiItems,a,3),0===n?(setMultiAnalysisStatus(`✔ Analyse terminée : ${t}/${e} ticket(s) - Vérifiez puis cliquez sur 💾 Enregistrer`,'#28a745'),showToast('✅ Analyse terminée - Vérifiez avant d\'enregistrer')):setMultiAnalysisStatus(`⚠ Analyse terminée : ${t} réussi(s), ${n} erreur(s) - Vérifiez avant d'enregistrer`,'#ff8c00');}catch{multiItems.forEach(e=>{'OK'!==e.status&&(e.status='Erreur',renderCard(e));}),setMultiAnalysisStatus('Erreur lors de l\'analyse multiple','#dc3545');}finally{updateBatchButtons();}}else{showToast('📴 Hors ligne - Analyse au retour en ligne'),setMultiAnalysisStatus('📴 Hors ligne - Analyse au retour en ligne','#ff8c00');for(const e of multiItems)e.status='📴 En attente de connexion',renderCard(e);pendingBatchAnalysis=!0;}}async function runBatchSave(){if(checkAuthorization('enregistrement multiple'))try{accessToken||await ensureConnected(!1),await api('/api/auth/me');const e=$('#sheetSelect')?.value||DEFAULT_SHEET,t=document.querySelector('input[name="whoTop"]:checked')?.value||'';if(!e||!t)throw new Error('Choisissez la feuille et “Qui scanne ?”.');const n=multiItems.map(e=>({ supplier:(e.supplier||'').trim(),dateISO:e.dateISO||'',total:'number'==typeof e.total?e.total:NaN,id:e.id })).filter(e=>e.supplier&&e.dateISO&&Number.isFinite(e.total));if(!n.length)throw new Error('Aucune carte complète à enregistrer.');setMultiAnalysisStatus(`Enregistrement de ${n.length} ticket(s)...`,'#007bff');let a=0,s=0;const i=async(i,o)=>{setMultiAnalysisStatus(`Écriture ${o+1}/${n.length} : ${i.supplier}...`,'#007bff');const r=100*o,c=200*Math.random();await new Promise(e=>setTimeout(e,r+c));const l=await api('/api/sheets/write',{ method:'POST',headers:{ 'Content-Type':'application/json' },body:JSON.stringify({ sheetName:e,who:t,supplier:i.supplier,dateISO:i.dateISO,total:i.total }) }),u=document.getElementById(i.id);if(u){const e=u.querySelector('.status-badge');l.ok?(a++,e&&(e.textContent='Enregistré ✔',e.classList.remove('status-analyse','status-error'),e.classList.add('status-ok')),setMultiAnalysisStatus(`✓ ${o+1}/${n.length} : ${i.supplier} enregistré`,'#28a745')):(s++,e&&(e.textContent='Erreur écriture',e.classList.remove('status-analyse','status-ok'),e.classList.add('status-error')),setMultiAnalysisStatus(`✗ ${o+1}/${n.length} : ${i.supplier} - erreur`,'#dc3545'));}return l.ok;};await runWithConcurrency(n,i,1),0===s?setMultiAnalysisStatus(`✔ Enregistrement terminé : ${a}/${n.length} ticket(s) enregistré(s) (onglet « ${e} », ${t})`,'#28a745'):0===a?setMultiAnalysisStatus(`✗ Échec : ${s}/${n.length} ticket(s) en erreur`,'#dc3545'):setMultiAnalysisStatus(`⚠ Terminé : ${a} réussi(s), ${s} erreur(s)`,'#ff8c00');}catch(e){setMultiAnalysisStatus('Erreur enregistrement multiple : '+(e.message||e),'#dc3545');}}function updateBatchButtons(){const e=multiItems.length>0&&multiItems.every(e=>'OK'===e.status),t=document.getElementById('btnBatchSave');t&&(t.disabled=!e);const n=$('#multiFiles');if(n){const e=multiItems.length>=MAX_UPLOADS;n.disabled=e,_fabAddLabel&&(_fabAddLabel.classList.toggle('is-disabled',e),_fabAddLabel.title=e?`Limite atteinte (${MAX_UPLOADS})`:'Ajouter des photos');}}